@page "/crm/equipo/{Id:int}"

@inject IRepositorio http
@inject SweetAlertService swal
@inject NavigationManager navigation
@attribute [Authorize(Roles = "Admin, VER_DETALLE_EQUIPO")]

<AuthorizeView Roles="Admin, VER_DETALLE_EQUIPO">
    <Authorized>
        <Card LoadingContent="loading_info">
            <Header>
                <div class="col-12 d-flex justify-content-between">
                    <b>Detalle de equipo</b>
                    <button class="g-1 btn gcom-bg-amarillo" onclick="history.back();">
                        <i class="fa fa-solid fa-arrow-left" /> Volver
                    </button>
                </div>
            </Header>
            <Body>
                <Card HeaderText="Datos principales" BodyClass="col-12 row">
                    <Body>
                        <div class="col-md-4 col-12">
                            <label><b>Equipo</b></label>
                            <p>@Equipo.Nombre</p>
                        </div>
                        <div class="col-md-4 col-12">
                            <label><b>Division</b></label>
                            <p>@Equipo.Division.Nombre</p>
                        </div>
                    </Body>
                </Card>
                <Card HeaderText="Integrantes de equipo" BodyClass="g-1">
                    <Body>
                        <label><b>Lider/es de equipo</b></label>
                        <div class="container-fluid overflow-scroll">
                            <Tabla Datos="Comerciales">
                                <Cabeceras>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Division</th>
                                        <th>Correo</th>
                                        <th>Telefono movil</th>
                                    </tr>
                                </Cabeceras>
                                <Columnas Context="item">
                                    <tr>
                                        <AuthorizeView Roles="Admin, VER_DETALLE_COMERCIAL">
                                            <Authorized Context="VERCOMERCIAL">
                                                <td>
                                                    <NavLink href=@($"crm/originador/{item.Id}")>
                                                        @item.Nombre @item.Apellidos
                                                    </NavLink>
                                                </td>
                                            </Authorized>
                                            <NotAuthorized Context="VERCOMERCIAL">
                                                <td>@item.Nombre @item.Apellidos</td>
                                            </NotAuthorized>
                                        </AuthorizeView>
                                        <td>@item.NombreDivision</td>
                                        <td>@item.Correo</td>
                                        <td>@item.Tel_Movil</td>
                                    </tr>
                                </Columnas>
                            </Tabla>
                        </div>
                        <div class="col-12">
                            <PaginacionComponent PaginaActual="filtroComercial.Pagina_ACtual" PaginasTotales="filtroComercial.Total_paginas"
                                                 Radio="5" PaginaSeleccionada="Pagina_SeleccionadaComercial" />
                        </div>
                        <label><b>Vendedores</b></label>
                        <div class="container-fluid overflow-scroll">
                            <Tabla Datos="Vendedores">
                                <Cabeceras>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Division</th>
                                        <th>Correo</th>
                                        <th>Telefono movil</th>
                                    </tr>
                                </Cabeceras>
                                <Filtros>
                                    <tr>
                                        <td>
                                            <input class="form-control" @bind-value="filtroVendedor.Nombre" @oninput="@((args)=>FiltrarParametrosVendedor(args, nameof(CRMVendedorDTO.Nombre)))" />
                                        </td>
                                        <td>
                                            <input class="form-control" @bind-value="filtroVendedor.NombreDivision" @oninput="@((args)=>FiltrarParametrosVendedor(args, nameof(CRMVendedorDTO.NombreDivision)))" />
                                        </td>
                                        <td>
                                            <input class="form-control" @bind-value="filtroVendedor.Correo" @oninput="@((args)=>FiltrarParametrosVendedor(args, nameof(CRMVendedorDTO.Correo)))" />
                                        </td>
                                        <td>
                                            <input class="form-control" @bind-value="filtroVendedor.Tel_Movil" @oninput="@((args)=>FiltrarParametrosVendedor(args, nameof(CRMVendedorDTO.Tel_Movil)))" />
                                        </td>
                                    </tr>
                                </Filtros>
                                <Columnas Context="item">
                                    <tr>
                                        <AuthorizeView Roles="Admin, VER_DETALLE_VENDEDORES">
                                            <Authorized Context="VERVENDEDOR">
                                                <td>
                                                    <NavLink href=@($"crm/vendedor/{item.Id}")>
                                                        @item.Fullname
                                                    </NavLink>
                                                </td>
                                            </Authorized>
                                            <NotAuthorized Context="VERVENDEDOR">
                                                <td>@item.Fullname</td>
                                            </NotAuthorized>
                                        </AuthorizeView>
                                        <td>@item.NombreDivision</td>
                                        <td>@item.Correo</td>
                                        <td>@item.Tel_Movil</td>
                                    </tr>
                                </Columnas>
                            </Tabla>
                        </div>
                        <div class="col-12">
                            <PaginacionComponent PaginaActual="filtroVendedor.Pagina_ACtual" PaginasTotales="filtroVendedor.Total_paginas"
                                                 Radio="5" PaginaSeleccionada="Pagina_Seleccionada" />
                        </div>
                    </Body>
                </Card>
            </Body>
        </Card>
    </Authorized>
    <NotAuthorized>
        <NoAutorizado />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter] public int Id { get; set; } = 0;
    bool loading_info = false;
    CRMEquipoDetalleDTO Equipo = new();

    Dictionary<string, string> query = new();
    CRMOriginadorDTO filtroComercial = new();
    List<CRMOriginadorDTO> Comerciales = new();
    CRMVendedorDTO filtroVendedor = new();
    List<CRMVendedorDTO> Vendedores = new();

    protected override async Task OnParametersSetAsync()
    {
        await Task.WhenAll(
            Obtener(),
            ObtenerVendedor(),
            ObtenerComercial()
        );
    }

    private async Task Obtener()
    {
        try
        {
            loading_info = true;
            var response = await http.Get<CRMEquipoDetalleDTO>($"api/crmequipo/{Id}/detalle");
            if (response.Error)
            {
                loading_info = false;
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                loading_info = false;
                Equipo = response.Response;
            }
        }
        catch (Exception e)
        {
            loading_info = false;
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }

    }

    private Dictionary<string, string> SetFiltro()
    {
        query[$"{nameof(filtroVendedor.Nombre)}"] = filtroVendedor.Nombre;
        query[$"{nameof(filtroVendedor.Tel_Movil)}"] = filtroVendedor.Tel_Movil;
        query[$"{nameof(filtroVendedor.Correo)}"] = filtroVendedor.Correo;
        query[$"{nameof(filtroVendedor.Pagina)}"] = filtroVendedor.Pagina.ToString();
        query[$"{nameof(filtroVendedor.EquipoId)}"] = Id.ToString();
        query[$"{nameof(filtroVendedor.Registros_por_pagina)}"] = filtroVendedor.Registros_por_pagina.ToString();
        query[nameof(filtroVendedor.Paginacion)] = true.ToString();
        return query;
    }

    private async Task ObtenerVendedor()
    {
        try
        {
            loading_info = true;
            var uri = Constructor_De_URL_Parametros.Generar_URL(SetFiltro());

            var response = await http.Get<List<CRMVendedorDTO>>($"api/crmvendedor?{uri}");
            if (response.Error)
            {
                loading_info = false;
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                loading_info = false;
                Vendedores = response.Response;

                filtroVendedor.Total_paginas = Constructor_De_URL_Parametros.Obt_Total_Paginas(response.HttpResponseMessage);
                filtroVendedor.Total_registros = Constructor_De_URL_Parametros.Obt_Total_Registros(response.HttpResponseMessage);
                filtroVendedor.Pagina_ACtual = Constructor_De_URL_Parametros.Obt_Pagina_Actual(response.HttpResponseMessage);
            }
        }
        catch (Exception e)
        {
            loading_info = false;
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private async Task FiltrarParametrosVendedor(ChangeEventArgs args, string param)
    {
        switch (param)
        {
            case nameof(CRMVendedorDTO.Nombre):
                filtroVendedor.Nombre = args.Value?.ToString() ?? string.Empty;
                break;
            case nameof(CRMVendedorDTO.Correo):
                filtroVendedor.Correo = args.Value?.ToString() ?? string.Empty;
                break;
            case nameof(CRMVendedorDTO.Tel_Movil):
                filtroVendedor.Tel_Movil = args.Value?.ToString() ?? string.Empty;
                break;
            default:
                break;
        }
        await ObtenerVendedor();
    }

    private async Task Pagina_Seleccionada(int pagina)
    {
        filtroVendedor.Pagina_ACtual = pagina;
        filtroVendedor.Pagina = pagina;

        await ObtenerVendedor();
    }

    private Dictionary<string, string> SetFiltroComercial()
    {
        query[$"{nameof(filtroComercial.Nombre)}"] = filtroComercial.Nombre;
        query[$"{nameof(filtroComercial.Tel_Movil)}"] = filtroComercial.Tel_Movil;
        query[$"{nameof(filtroComercial.Correo)}"] = filtroComercial.Correo;
        query[$"{nameof(filtroComercial.Pagina)}"] = filtroComercial.Pagina.ToString();
        query[$"{nameof(filtroComercial.EquipoId)}"] = Id.ToString();
        query[$"{nameof(filtroComercial.Registros_por_pagina)}"] = filtroComercial.Registros_por_pagina.ToString();
        query[nameof(filtroComercial.Paginacion)] = true.ToString();
        return query;
    }

    private async Task ObtenerComercial()
    {
        try
        {
            loading_info = true;
            var uri = Constructor_De_URL_Parametros.Generar_URL(SetFiltroComercial());

            var response = await http.Get<List<CRMOriginadorDTO>>($"api/crmoriginador?{uri}");
            if (response.Error)
            {
                loading_info = false;
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                loading_info = false;
                Comerciales = response.Response;

                filtroComercial.Total_paginas = Constructor_De_URL_Parametros.Obt_Total_Paginas(response.HttpResponseMessage);
                filtroComercial.Total_registros = Constructor_De_URL_Parametros.Obt_Total_Registros(response.HttpResponseMessage);
                filtroComercial.Pagina_ACtual = Constructor_De_URL_Parametros.Obt_Pagina_Actual(response.HttpResponseMessage);
            }
        }
        catch (Exception e)
        {
            loading_info = false;
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private async Task FiltrarParametrosComercial(ChangeEventArgs args, string param)
    {
        switch (param)
        {
            case nameof(CRMOriginadorDTO.Nombre):
                filtroVendedor.Nombre = args.Value?.ToString() ?? string.Empty;
                break;
            case nameof(CRMOriginadorDTO.Correo):
                filtroVendedor.Correo = args.Value?.ToString() ?? string.Empty;
                break;
            case nameof(CRMOriginadorDTO.Tel_Movil):
                filtroVendedor.Tel_Movil = args.Value?.ToString() ?? string.Empty;
                break;
            default:
                break;
        }
        await ObtenerVendedor();
    }

    private async Task Pagina_SeleccionadaComercial(int pagina)
    {
        filtroComercial.Pagina_ACtual = pagina;
        filtroComercial.Pagina = pagina;

        await ObtenerComercial();
    }
}
