@page "/redireccionamiento"
@inject IRepositorio http
@inject SweetAlertService swal
@inject DialogService ds
@inject IJSRuntime js
@inject NotificationService ms

@attribute [Authorize(Roles = "Admin, Administrador Sistema, Programador")]

<AuthorizeView Roles="Admin, Administrador Sistema, Programador" Context="Redireccionamiento">
    <div class="col-12 card">
        <div class="col-12 card-header">
            <b>Redireccionamiento</b>
        </div>
        <div class="col-12 card-body">
            <div class="col-12">
                <div class="col-12 row my-1">
                    <div class="col-2">
                        <input class="col-12 form-control form-control-sm" type="number" @bind="filtroDTO.Bol" min="0" placeholder="BOL/Embarque" />
                    </div>
                    <div class="col-1">
                        <button class="btn btn-sm gcom-bg-amarillo col-12" @onclick="@Buscar_Ordenes">
                            <i class="fa fa-solid fa-magnifying-glass"></i>
                            @if (Loading_Buscar)
                            {
                                <SpinnerLoading />
                            }
                        </button>
                    </div>
                </div>

                <EditForm Model="@Redireccion" OnValidSubmit="@Crear_Redireccion" class="col-12 form row">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="col-4">
                        <label>Grupo</label>
                        <DropDownFilter Listado="Grupos" TListado="Grupo" @bind-Valor="@Redireccion.Grupo_Red" Propiedad_Valor="Cod" TValue="Int16" FiltrarValor="GetGrupos"
                                        Default_Placeholder="-- Seleccione un grupo --" On_Change_Method="@(()=>GetClientes(string.Empty))">
                            <RenderValue Context="grupo">
                                @grupo.Den
                            </RenderValue>
                            <Render Context="grupo">
                                @grupo.Den
                            </Render>
                        </DropDownFilter>
                        <ValidationMessage For="@(()=>Redireccion.Grupo_Red)" />

                    </div>
                    <div class="col-4">
                        <label>Cliente</label>
                        <DropDownFilter Listado="Clientes" TListado="CodDenDTO" @bind-Valor="@Redireccion.Cliente_Red" Propiedad_Valor="Cod" TValue="int" FiltrarValor="@GetClientes"
                                        Default_Placeholder="-- Seleccione un cliente --" On_Change_Method="@(()=>GetEstaciones(string.Empty))">
                            <RenderValue Context="cliente">
                                @cliente.Den
                            </RenderValue>
                            <Render Context="cliente">
                                @cliente.Den
                            </Render>
                        </DropDownFilter>
                        <ValidationMessage For="@(()=>Redireccion.Cliente_Red)" />
                    </div>
                    <div class="col-4">
                        <label>Destino</label>
                        <DropDownFilter Listado="Destinos" TListado="DestinoDTO" @bind-Valor="@Redireccion.Destino_Red" Propiedad_Valor="Cod" TValue="int" FiltrarValor="@GetEstaciones"
                                        Default_Placeholder="-- Seleccione un destino --" On_Change_Method="GetPrecioEstacion">
                            <RenderValue Context="destino">
                                @destino.Den
                            </RenderValue>
                            <Render Context="destino">
                                @destino.Den
                            </Render>
                        </DropDownFilter>
                        <ValidationMessage For="@(()=>Redireccion.Destino_Red)" />
                    </div>

                    <div class="col-4">
                        <label>Precio</label>
                        <input type="number" step="0.0001" @bind="@Redireccion.Precio_Red" class="form-control form-control-sm" />
                        <ValidationMessage For="@(()=>Redireccion.Precio_Red)" />
                    </div>

                    <div class="col-4">
                        <label>Motivo</label>
                        <textarea class="form-control form-control-sm" @bind="Redireccion.Motivo_Red" maxlength="250" />
                        <ValidationMessage For="@(()=>Redireccion.Motivo_Red)" />
                    </div>

                    <div class="col-4">
                        <label>Fecha de redireccion</label>
                        <input @bind="Redireccion.Fecha_Red" type="date" class="form-control form-control-sm" min="@DateTime.Today" />
                        <ValidationMessage For="@(()=>Redireccion.Fecha_Red)" />
                    </div>

                    <div class="col-12 d-flex justify-content-center mt-1">
                        <div class="col-4">
                            <button class="col-12 btn btn-sm gcom-bg-amarillo" type="submit">
                                Guardar
                                @if (Loading_Guardar)
                                {
                                    <SpinnerLoading />
                                }
                            </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
    <div class="col-12 overflow-scroll ancho" style="height:450px;resize:both;">
        <table class="table table-sm table-bordered table-hover" id="miTabla">
            <thead class="fila">
                <tr style="max-height:50px;white-space:nowrap;">
                    <th style="min-width:80px;width:80px">
                        Redireccionar
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:150px;">
                        Fecha de carga
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:300px;">
                        Cliente
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:300px;">
                        Producto
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:300px;">
                        Destino
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:100px;">
                        Precio
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:150px;">
                        Volumen cargado
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:150px;">
                        Referencia
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:120px;">
                        BOL/Embarque
                    </th>
                    <th class="th-resizable overflow-hidden" style="min-width:20px;width:160px;">
                        Estado
                    </th>
                </tr>
            </thead>
            <tbody>
                @if (Loading_Buscar || Loading_Guardar)
                {
                    <tr>
                        <td colspan="10">
                            <SpinnerLoading />
                        </td>
                    </tr>
                }
                else if (Ordenes_Synthesis.Count == 0 || Ordenes_Synthesis is null)
                {
                    <tr>
                        <td colspan="10">
                            No hay registros
                        </td>
                    </tr>
                }
                else
                {
                    <Virtualize Items="@Ordenes_Synthesis" Context="item" TItem="Orden">
                        <tr style="white-space:nowrap;" class="@(Ordenes_Synthesis.Any(x=>x.Cod == Redireccion.Id_Orden) ? "table-active" : string.Empty )">
                            <td>
                                <div>
                                    @if (item.Redireccionamiento is null)
                                    {
                                        <button class="btn btn-sm gcom-bg-amarillo" @onclick="@(()=>Establecer_Redireccion(item))">
                                            <i class="fa fa-solid fa-diamond-turn-right"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Fchcar?.ToString("dd/MM/yyyy")
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Obtener_Cliente
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Producto?.Den
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Obtener_Destino
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Obtener_Precio.ToString("N4", CultureInfo.InvariantCulture)
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Vol?.ToString("N", CultureInfo.InvariantCulture)
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Ref
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.BatchId
                                </div>
                            </td>
                            <td class="overflow-hidden">
                                <div class="text-hidden-overflow">
                                    @item.Estado?.den
                                </div>
                            </td>
                        </tr>
                    </Virtualize>
                }
            </tbody>
        </table>
    </div>
</AuthorizeView>
<style type="text/css">
    table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
        text-align: left;
        table-layout: fixed;
    }

    table, th, td {
        background-color: white;
    }

    .fila th {
        position: -webkit-sticky;
        position: sticky;
        text-align: center;
        top: 0;
        background-color: #f2f2f2;
    }

    .fila td {
        position: -webkit-sticky;
        position: sticky;
        text-align: center;
        top: 28px;
        background-color: #f2f2f2;
    }

    .ancho {
        width: calc(100vw - 100px);
    }

    tr:hover {
        background-color: #FFF633;
    }

    tr:active {
        background-color: #FFF633;
    }

    .asignar {
        table-layout: auto;
        width: auto;
    }

    .sticky-column {
        position: sticky;
        left: 0;
        z-index: 1;
        background-color: white;
    }

    .sticky-column-header {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 2;
        background-color: white;
    }

    .sticky-column, .sticky-column + th, .sticky-column + td {
        min-width: 180px;
    }

    .table-container {
        overflow: auto;
        width: 100%;
        border: 1px solid #ccc;
        max-height: 400px; /* Establece una altura máxima si es necesario */
    }

    th, td {
        padding: 8px;
        border: 1px solid #ccc;
    }

    .th-resizable {
        position: relative;
        cursor: col-resize;
    }

        .th-resizable::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 8px; /* Ancho del área de redimensionamiento */
            background: transparent;
        }
</style>

@code {
    Redireccionamiento Redireccion { get; set; } = new();
    List<Grupo> Grupos { get; set; } = new();
    List<CodDenDTO> Clientes { get; set; } = new();
    List<DestinoDTO> Destinos { get; set; } = new();
    List<Orden> Ordenes_Synthesis { get; set; } = new();

    Pedimento Pedimento { get; set; } = new();
    CierreFiltroDTO filtroDTO = new();

    Dictionary<string, string> Query = new();

    List<Pedimento> Pedimentos { get; set; } = new();
    List<Producto> Productos { get; set; } = new();
    List<OrdenEmbarque> Ordenes { get; set; } = new();

    bool Loading_Guardar = false;
    bool Loading_Buscar = false;

    int width = 0;
    bool isClose = false;
    string TotalWidth = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await GetGrupos(string.Empty);
        await js.InvokeVoidAsync("importarScript", "js/resizableTable.js");
    }

    public async Task GetGrupos(string value)
    {
        try
        {
            Dictionary<string, string> query = new();
            query["Grupo_Filtrado"] = value;
            var uri = Constructor_De_URL_Parametros.Generar_URL(query);

            var response = await http.Get<List<Grupo>>($"api/grupo?{uri}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                Grupos = response.Response;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
            throw e;
        }
    }

    private async Task Buscar_Ordenes()
    {
        try
        {
            Loading_Buscar = true;

            if (filtroDTO.Bol is null)
                return;

            var response = await http.Get<List<Orden>>($"api/pedido/ordenes/despachadas/{filtroDTO.Bol}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
                Loading_Buscar = false;
            }
            else
            {
                Ordenes_Synthesis = response.Response;

                if (Ordenes_Synthesis.Count > 0)
                {
                    var first_orden = Ordenes_Synthesis.FirstOrDefault();
                    if (first_orden is not null)
                        if (first_orden.Cod is not null)
                            Redireccion.Id_Orden = (long)first_orden.Cod;
                }

                Loading_Buscar = false;
                var response_Precio = await http.Get<PrecioBolDTO>($"api/precio/bol/{filtroDTO.Bol}");
                if (response_Precio.Error)
                {
                    var message = await response_Precio.ObtenerMensajeError();
                    await swal.FireAsync("Error", message, SweetAlertIcon.Error);
                    Loading_Buscar = false;
                }
                else
                {
                    if (response_Precio.Response is not null && response_Precio.Response.Precio is not null)
                        Redireccion.Precio_Red = (double)response_Precio.Response.Precio;

                    Loading_Buscar = false;
                }
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
            Loading_Buscar = false;
        }
    }

    private async Task Crear_Redireccion()
    {
        try
        {
            if (Redireccion.Id_Orden == 0)
            {
                await swal.FireAsync("Aviso", "Seleccione una orden para redireccionar.", SweetAlertIcon.Warning);
                return;
            }

            Dictionary<string, string> keyValues = new();
            keyValues["ID_Orden"] = Redireccion.Id_Orden.ToString();
            var uri = Constructor_De_URL_Parametros.Generar_URL(keyValues);
            var response = await http.Get<bool>($"api/redireccion/checar?{uri}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
                Loading_Guardar = false;
            }
            else
            {
                if (!response.Response)
                {
                    Loading_Guardar = true;
                    var responseSave = await http.Post<Redireccionamiento>("api/redireccion", Redireccion);
                    if (responseSave.Error)
                    {
                        var message = await responseSave.ObtenerMensajeError();
                        await swal.FireAsync("Error", message, SweetAlertIcon.Error);
                        Loading_Guardar = false;
                    }
                    else
                    {
                        ms.Notify(new NotificationMessage()
                            {
                                Summary = "Redireccion registrada",
                                Detail = "Se ha registrado la redireccion de la orden.",
                                Duration = 5000,
                                Severity = NotificationSeverity.Success
                            });
                        await Buscar_Ordenes();
                        Loading_Guardar = false;
                    }
                }
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
            Loading_Guardar = false;
        }
    }

    public async Task GetClientes(string value)
    {
        try
        {
            Dictionary<string, string> query = new();
            query["Cliente_Filtrado"] = value;
            query["ID_Grupo"] = Redireccion.Grupo_Red.ToString();

            var uri = Constructor_De_URL_Parametros.Generar_URL(query);

            var response = await http.Get<List<CodDenDTO>>($"api/clientes?{uri}");
            if (response.Error)
            {
                var message = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", message, SweetAlertIcon.Error);
            }
            else
            {
                Clientes = response.Response;
                StateHasChanged();
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private async Task GetEstaciones(string value)
    {
        try
        {
            Dictionary<string, string> query = new();
            query[nameof(DestinoDTO.Den)] = value;
            query[nameof(DestinoDTO.Codcte)] = Redireccion.Cliente_Red.ToString();

            var uri = Constructor_De_URL_Parametros.Generar_URL(query);

            var response = await http.Get<List<DestinoDTO>>($"api/estacion?{uri}");
            if (response.Error)
            {
                var responseHttp = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", responseHttp, SweetAlertIcon.Error);
            }
            else
            {
                Destinos = response.Response;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private void Establecer_Redireccion(Orden orden)
    {
        if (orden.Cod is not null)
            Redireccion.Id_Orden = (long)orden.Cod;
    }

    private async Task Exportar_Excel()
    {
        try
        {
            var response = await http.Post<List<OrdenEmbarque>, List<Excel_Ordenes_Pedimento>>($"api/excel/reporte/ordenes/pedimento", Ordenes);
            if (response.Error)
            {
                var responseHttp = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", responseHttp, SweetAlertIcon.Error);
            }
            else
            {
                ExcelPackage.LicenseContext = LicenseContext.Commercial;
                var excel = new ExcelPackage();
                var ws = excel.Workbook.Worksheets.Add("ordenes de pedimento");
                ws.Columns.Width = 50;

                var header = ws.Cells["A1:M1"];

                ws.Cells["F1:H1"].Style.Numberformat.Format = "#,####0.0000";
                ws.Cells["I1:J1"].Style.Numberformat.Format = "#,##0.00";

                // ws.Cells["A1:E1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                // ws.Cells["K1:M1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                // ws.Cells["F1:J1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.Right;

                var tablebody = ws.Cells["A1:A1"].LoadFromCollection(response.Response, true);
                tablebody.Style.Font.Size = 12;
                // tablebody.Style.HorizontalAlignment = ExcelHorizontalAlignment.Center;
                tablebody.Style.Font.Bold = true;
                header.Style.Font.Size = 14;

                header.Style.Fill.PatternType = ExcelFillStyle.Solid;
                header.Style.Fill.BackgroundColor.SetColor(Color.LightGray);
                header.Style.Font.Bold = true;

                await js.GuardarComo($"Costos_{DateTime.Now.ToString("yyyy_MM_dd_HH_mm_ss")}.xlsx", excel.GetAsByteArray());
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }

    private async Task GetPrecioEstacion()
    {
        try
        {
            var response = await http.Get<PrecioBolDTO>($"api/precio/destino/{Redireccion.Destino_Red}/{Redireccion.Id_Orden}");
            if (response.Error)
            {
                var responseHttp = await response.ObtenerMensajeError();
                await swal.FireAsync("Error", responseHttp, SweetAlertIcon.Error);
            }
            else
            {
                if (response.Response is not null && response.Response.Precio is not null)
                    Redireccion.Precio_Red = (double)response.Response.Precio;
            }
        }
        catch (Exception e)
        {
            await swal.FireAsync("Error", e.Message, SweetAlertIcon.Error);
        }
    }
}
